# Testing Policy

This document is the single source of truth for daily local testing, PR readiness checks, and release-oriented validation.

## Testing Ladder (from fastest to strictest)

### Level 1: Daily local work (every day)

Goal: very fast feedback while coding.

Run:

```bash
source .venv/bin/activate || true
pytest -q
```

When frontend code changes, add:

```bash
npm --prefix web-next run lint
```

### Level 2: Branch ready for PR (mandatory before push)

Goal: verify the branch with lightweight PR-equivalent gates.

Run one command:

```bash
make pr-fast
```

What it includes:

- changed-file scope detection against `origin/main` (or `PR_BASE_REF`)
- backend fast lane: compile check + CI-lite audit + changed-lines coverage gate
- frontend fast lane (only when `web-next/**` changed): lint + unit CI-lite

### Level 3: PR quality gates (mandatory before merge)

Goal: align with CI and Sonar expectations.

Required checks:

1. `pre-commit run --all-files`
2. `mypy venom_core`
3. `make check-new-code-coverage`

Coverage gate defaults:

- diff base: `origin/main`
- minimum changed-lines coverage: `70%`

Useful overrides:

```bash
NEW_CODE_CHANGED_LINES_MIN=80 make check-new-code-coverage
NEW_CODE_DIFF_BASE=origin/main make check-new-code-coverage
```

### Level 4: Release-oriented validation (when needed)

Goal: higher confidence for larger changes or pre-release checks.

Backend:

```bash
make pytest
```

Frontend:

```bash
npm --prefix web-next run build
npm --prefix web-next run test:e2e
```

Sonar report bundle:

```bash
make sonar-reports
```

Artifacts:

- `test-results/sonar/python-coverage.xml`
- `test-results/sonar/python-junit.xml`
- `web-next/coverage/lcov.info`

Performance/latency scenarios:

- `docs/TESTING_CHAT_LATENCY.md`
- `npm --prefix web-next run test:perf`
- `pytest tests/perf/test_chat_pipeline.py -m performance`
- `./scripts/run-locust.sh`

## CI and Sonar Gates (reference)

Required PR gates:

- CI Lite (fast lint + selected unit tests)
- SonarCloud (bugs, vulnerabilities, maintainability, duplication)

## Test Artifacts Policy

Do not commit test output artifacts.

Ignored by policy:

- `**/test-results/`
- `perf-artifacts/`
- `playwright-report/`
- Sonar local artifacts generated by `make sonar-reports`
