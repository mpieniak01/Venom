# Analiza Refaktoryzacji SonarQube (127)

Ten dokument zawiera plan refaktoryzacji mający na celu zmniejszenie złożoności poznawczej (Cognitive Complexity) oraz naprawę innych zapachów kodu (code smells) zidentyfikowanych przez SonarQube w projekcie `web-next`.

## Główne Cele
1. Zmniejszenie Cognitive Complexity w kluczowych komponentach do poziomu <= 15.
2. Naprawa powtarzających się wzorców, takich jak zagnieżdżone ternaria i brak opcjonalnego łańcuchowania (optional chaining).
3. Poprawa typowania i struktur danych (np. użycie `Set` zamiast tablic dla statusów).

## Zidentyfikowane Problemy i Plan Naprawy

### 1. Cognitive Complexity

| Plik | Funkcja/Komponent | Aktualna Złożoność | Cel | Plan Naprawy |
| :--- | :--- | :---: | :---: | :--- |
| `brain-home.tsx` | `BrainHome` | 53 | 15 | Wydzielenie logiki grafu do `useBrainGraph`, filtrów do `useBrainFilters`, a elementów UI do subkomponentów (`BrainStats`, `BrainLessons`). |
| `cockpit-chat-send.ts` | `useChatSend` | 20 | 15 | Rozbicie dużego hooka na mniejsze: `useChatHandlers`, `useStreamUpdates`, `useAttachmentHandling`. |
| `models-viewer.tsx` | `ModelsViewer` | 30 | 15 | [x] Wydzielenie sekcji katalogu, zainstalowanych modeli i operacji do osobnych komponentów. |
| `sidebar.tsx` | `Sidebar` | 17 | 15 | Uproszczenie mapowania elementów nawigacji i wydzielenie `SidebarSettings`. |
| `cockpit-request-detail-drawer.tsx` | `CockpitRequestDetailDrawer` | 16 | 15 | Uproszczenie warunkowego renderowania detali żądania. |

### 2. Inne Code Smells

- **Zagnieżdżone Ternaria**: Zamiana na instrukcje `if` lub wydzielenie zmiennych pomocniczych w:
  - `mobile-nav.tsx`
  - `system-status-bar.tsx`
  - `system-status-panel.tsx`
  - `button.tsx`
  - `section-heading.tsx`
  - `voice-command-center.tsx`
  - `use-api.ts`
- **Optional Chaining**: Wprowadzenie `?.` w:
  - `use-cockpit-logic.ts`
  - `models-viewer.tsx`
  - `voice-command-center.tsx`
  - `select-menu.tsx`
- **Klucze Tablic (Array Index)**: Użycie unikalnych ID zamiast indeksów w `CockpitRequestDetailDrawer` i `ServicesPanel`.
- **DOM Manipulation**: Zamiana `parentNode.removeChild(childNode)` na `childNode.remove()` w `system-status-bar.tsx`.
- **Struktury Danych**: Zamiana `TERMINAL_STATUSES` na `Set` w `use-task-stream.ts`.
- **Parametry Funkcji**: Redukcja liczby parametrów `sendTask` w `use-api.ts` poprzez grupowanie ich w obiekt.
- **Regex**: Usunięcie duplikatów w klasie znaków w `markdown-format.ts`.
- **Readonly**: Oznaczenie `maxAttempts` jako `readonly` w `ws-client.ts`.

## Analiza Pokrycia Testami i Ryzyka
Refaktoryzacja dużej skali niesie ryzyko spadku pokrycia testami (Code Coverage), szczególnie gdy logika jest przenoszona do nowych hooków lub komponentów, które nie są automatycznie uwzględniane w istniejących testach.

**Zasady zachowania pokrycia:**
1. **Zachowanie Interfejsów**: Nowe hooki (np. `useBrainGraphLogic`) powinny mieć jasno zdefiniowane interfejsy, które można łatwo przetestować jednostkowo.
2. **Testy Regresji**: Przed i po zmianach uruchamiane będą testy E2E (`test:e2e:functional`), aby upewnić się, że główny flow komponentów (Brain, Cockpit) pozostał nienaruszony.
3. **Nowe Testy "Lite"**: Dla nowo wydzielonej logiki w `lib/` i `hooks/`, będę dodawał lekkie testy jednostkowe w `web-next/tests/`, wykorzystując natywny test runner Node.js, co nie obciąża CI ciężkimi zależnościami.
4. **Sonar Scan**: Po zakończeniu prac należy zweryfikować stan w SonarCloud, aby upewnić się, że parametr "New Code Coverage" jest na wymaganym poziomie (>80%).

## Analiza Stacku CI
Obecnie `frontend-lite` w GitHub Actions wykonuje jedynie `lint`. Testy jednostkowe (`test:unit:ci-lite`) nie są uruchamiane automatycznie w głównym cyklu CI, mimo że są sprawdzane w `quick-validate.yml`.

**Rozszerzenie wprowadzone:**
1. [x] Dodanie kroku `npm run test:unit` do workflow `ci.yml` w sekcji `frontend-lite`.
2. [x] Weryfikacja poprawności działania testów w potoku CI.

## Plan Weryfikacji
1. Uruchomienie istniejących testów jednostkowych dla `web-next`.
2. Dodanie testów jednostkowych do potoku CI (`frontend-lite`).
3. Manualna weryfikacja UI w Cockpit, Brain oraz ustawieniach modeli.
4. Sprawdzenie poprawności działania WebSocketów po zmianach w `ws-client.ts`.
