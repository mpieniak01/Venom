// AUTO-GENERATED by scripts/generate-optional-modules.mjs. Do not edit manually.

import type { ComponentType } from "react";
import type { LucideIcon } from "lucide-react";
import { Settings } from "lucide-react";

export type OptionalModuleManifest = {
  schemaVersion: number;
  moduleId: string;
  displayName: string;
  routePath: string;
  featureFlagEnv: string | null;
  navLabel: string;
  navLabels: {
    pl: string;
    en: string;
    de: string;
  };
};

export type OptionalModuleNavItem = {
  href: string;
  label: string;
  labels: {
    pl: string;
    en: string;
    de: string;
  };
  icon: LucideIcon;
  featureFlagEnv?: string;
};

const OPTIONAL_MODULES: OptionalModuleManifest[] = [
  {
    schemaVersion: 1,
    moduleId: "brand_studio",
    displayName: "Brand Studio",
    routePath: "/brand-studio",
    featureFlagEnv: "NEXT_PUBLIC_FEATURE_BRAND_STUDIO",
    navLabel: "Brand Studio",
    navLabels: {
      pl: "Brand Studio",
      en: "Brand Studio",
      de: "Brand Studio",
    },
  },
  {
    schemaVersion: 1,
    moduleId: "module_example",
    displayName: "Module Example",
    routePath: "/module-example",
    featureFlagEnv: "NEXT_PUBLIC_FEATURE_MODULE_EXAMPLE",
    navLabel: "Module Example",
    navLabels: {
      pl: "Moduł przykładowy",
      en: "Module Example",
      de: "Beispielmodul",
    },
  }
];

const OPTIONAL_MODULE_COMPONENT_LOADERS: Record<string, () => Promise<ComponentType | null>> = {
  "brand_studio": async () => importOptionalModuleComponent("../../../modules/venom-module-brand-studio/web-next/page"),
  "module_example": async () => importOptionalModuleComponent("../../../modules/venom-module-example/web-next/page")
};

const OPTIONAL_MODULE_IMPORT_PATH_RE =
  /^(?:@\/components\/modules\/[a-zA-Z0-9._/-]+|(?:\.\.\/)+modules\/[a-zA-Z0-9._/-]+)$/;

function isSafeOptionalModuleImportPath(modulePath: string): boolean {
  return OPTIONAL_MODULE_IMPORT_PATH_RE.test(modulePath);
}

async function importOptionalModuleComponent(
  modulePath: string,
): Promise<ComponentType | null> {
  try {
    if (!isSafeOptionalModuleImportPath(modulePath)) {
      return null;
    }
    // Intentionally dynamic to keep optional modules out of static bundles
    // when feature-flagged off. modulePath is validated above.
    const dynamicImport = new Function(
      "modulePath",
      "return import(modulePath);",
    ) as (path: string) => Promise<{ default?: ComponentType }>;
    const loaded = await dynamicImport(modulePath);
    return loaded.default ?? null;
  } catch (error) {
    if (process.env.NODE_ENV !== "production") {
      console.warn("[modules] Optional module import failed:", modulePath, error);
    }
    return null;
  }
}

const OPTIONAL_MODULE_FLAG_GETTERS: Record<string, () => string> = {
  "brand_studio": () => process.env.NEXT_PUBLIC_FEATURE_BRAND_STUDIO ?? "",
  "module_example": () => process.env.NEXT_PUBLIC_FEATURE_MODULE_EXAMPLE ?? ""
};

function isFlagEnabled(raw: string): boolean {
  if (!raw) {
    return false;
  }
  const normalized = raw.trim().toLowerCase();
  return normalized === "1" || normalized === "true" || normalized === "yes" || normalized === "on";
}

export function getOptionalModuleManifests(): OptionalModuleManifest[] {
  return OPTIONAL_MODULES.slice();
}

export function getEnabledOptionalModuleNavItems(): OptionalModuleNavItem[] {
  return OPTIONAL_MODULES.filter((moduleItem) => {
    if (!moduleItem.featureFlagEnv) {
      return true;
    }
    const raw = OPTIONAL_MODULE_FLAG_GETTERS[moduleItem.moduleId]?.() ?? "";
    return isFlagEnabled(raw);
  }).map((moduleItem) => ({
    href: moduleItem.routePath,
    label: moduleItem.navLabel,
    labels: moduleItem.navLabels,
    icon: Settings,
    featureFlagEnv: moduleItem.featureFlagEnv ?? undefined,
  }));
}

export function resolveOptionalModuleBySlug(slug: string): OptionalModuleManifest | null {
  const target = "/" + String(slug || "").replace(/^\/+/, "");
  for (const item of OPTIONAL_MODULES) {
    if (item.routePath === target) {
      return item;
    }
  }
  return null;
}

export async function getOptionalModuleComponent(moduleId: string): Promise<ComponentType | null> {
  const loader = OPTIONAL_MODULE_COMPONENT_LOADERS[moduleId];
  if (!loader) {
    return null;
  }
  return loader();
}
