{% extends "base.html" %}

{% block title %}Flow Inspector - Venom{% endblock %}

{% block nav_flow_active %}active{% endblock %}

{% block extra_css %}
<style>
    .flow-inspector-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .flow-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .flow-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .flow-header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    .task-selector {
        background: var(--bg-panel);
        backdrop-filter: blur(10px);
        border: var(--border-glass);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .task-selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .task-selector-header h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--text-primary);
    }

    .task-list-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.2);
    }

    .task-item {
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid transparent;
    }

    .task-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(4px);
    }

    .task-item.selected {
        background: rgba(139, 92, 246, 0.15);
        border-left-color: var(--primary-color);
    }

    .task-item.status-completed {
        border-left-color: var(--success-color);
    }

    .task-item.status-failed {
        border-left-color: var(--error-color);
    }

    .task-item.status-processing {
        border-left-color: var(--warning-color);
    }

    .task-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.3rem;
    }

    .task-item-id {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-primary);
        font-family: var(--font-tech);
    }

    .task-item-status {
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-completed { background: rgba(16, 185, 129, 0.2); color: var(--success-color); }
    .status-failed { background: rgba(239, 68, 68, 0.2); color: var(--error-color); }
    .status-processing { background: rgba(245, 158, 11, 0.2); color: var(--warning-color); }
    .status-pending { background: rgba(6, 182, 212, 0.2); color: var(--secondary-color); }

    .task-item-prompt {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.3rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .task-item-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        font-family: var(--font-tech);
    }

    .flow-visualization {
        background: var(--bg-panel);
        backdrop-filter: blur(10px);
        border: var(--border-glass);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .flow-visualization-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .flow-visualization-header h3 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--text-primary);
    }

    .refresh-btn {
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .refresh-btn:hover {
        background: #7c3aed;
        box-shadow: var(--glow-hover);
    }

    .mermaid-container {
        text-align: center;
        padding: 2rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow-x: auto;
    }

    .flow-details {
        background: var(--bg-panel);
        backdrop-filter: blur(10px);
        border: var(--border-glass);
        border-radius: 12px;
        padding: 2rem;
    }

    .flow-details h3 {
        margin-bottom: 1rem;
        font-size: 1.4rem;
        color: var(--text-primary);
    }

    .flow-steps {
        list-style: none;
        padding: 0;
    }

    .flow-step {
        padding: 1rem;
        margin-bottom: 0.8rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 4px solid var(--border-color);
        transition: all 0.2s;
    }

    .flow-step:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .flow-step.decision-gate {
        background: rgba(245, 158, 11, 0.15);
        border-left-color: var(--warning-color);
    }

    .flow-step.error {
        background: rgba(239, 68, 68, 0.15);
        border-left-color: var(--error-color);
    }

    .flow-step-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .flow-step-component {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
        font-family: var(--font-tech);
    }

    .flow-step-time {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-family: var(--font-tech);
    }

    .flow-step-action {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.3rem;
    }

    .flow-step-details {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-style: italic;
    }

    .decision-gate-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        background: var(--warning-color);
        color: white;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="flow-inspector-container">
    <div class="flow-header">
        <h1> Flow Inspector</h1>
        <p>Dynamiczna wizualizacja proces贸w decyzyjnych systemu Venom</p>
    </div>

    <!-- Task Selector -->
    <div class="task-selector">
        <div class="task-selector-header">
            <h3> Wybierz zadanie do analizy</h3>
            <button id="refreshTasksBtn" class="refresh-btn"> Odwie偶</button>
        </div>
        <div class="task-list-container" id="taskListContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>adowanie zada...</p>
            </div>
        </div>
    </div>

    <!-- Flow Visualization -->
    <div class="flow-visualization" id="flowVisualization" style="display: none;">
        <div class="flow-visualization-header">
            <h3> Diagram przepywu</h3>
            <button id="refreshFlowBtn" class="refresh-btn"> Odwie偶</button>
        </div>
        <div class="mermaid-container" id="mermaidContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Generowanie diagramu...</p>
            </div>
        </div>
    </div>

    <!-- Flow Details -->
    <div class="flow-details" id="flowDetails" style="display: none;">
        <h3> Szczeg贸y przepywu</h3>
        <ul class="flow-steps" id="flowStepsList">
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Konfiguracja
    const AUTO_REFRESH_INTERVAL_MS = 3000; // Co 3 sekundy dla zada w trakcie
    
    // Helper function do escapowania HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Inicjalizacja Mermaid
    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'dark',
        securityLevel: 'strict',  // Bezpieczniejszy tryb dla production
        themeVariables: {
            primaryColor: '#8b5cf6',
            primaryTextColor: '#f1f5f9',
            primaryBorderColor: '#00ff9d',
            lineColor: '#00ff9d',
            secondaryColor: '#06b6d4',
            tertiaryColor: '#1e293b',
            background: '#0f172a',
            mainBkg: '#1e293b',
            secondBkg: '#334155',
            textColor: '#f1f5f9',
            border1: '#475569',
            border2: '#64748b'
        },
        sequence: {
            showSequenceNumbers: true,
            actorMargin: 50,
            width: 150,
            height: 65,
            boxMargin: 10,
            noteMargin: 10
        }
    });

    let selectedTaskId = null;
    let refreshInterval = null;

    // Funkcja do adowania listy zada
    async function loadTasks() {
        try {
            const response = await fetch('/api/v1/history/requests?limit=50');
            const tasks = await response.json();
            
            const container = document.getElementById('taskListContainer');
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Brak zada w historii</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-item status-${escapeHtml(task.status.toLowerCase())}" data-task-id="${escapeHtml(task.request_id)}">
                    <div class="task-item-header">
                        <span class="task-item-id">${escapeHtml(task.request_id?.slice(0, 8) || 'unknown')}...</span>
                        <span class="task-item-status status-${escapeHtml(task.status.toLowerCase())}">${escapeHtml(task.status)}</span>
                    </div>
                    <div class="task-item-prompt">${escapeHtml(task.prompt)}</div>
                    <div class="task-item-time">${escapeHtml(new Date(task.created_at).toLocaleString('pl-PL'))}</div>
                </div>
            `).join('');

            // Dodaj event listenery do zada
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', () => {
                    const taskId = item.dataset.taskId;
                    selectTask(taskId);
                });
            });
        } catch (error) {
            console.error('Bd podczas adowania zada:', error);
            document.getElementById('taskListContainer').innerHTML = `
                <div class="empty-state">
                    <p>Bd podczas adowania zada</p>
                </div>
            `;
        }
    }

    // Funkcja do wyboru zadania
    function selectTask(taskId) {
        selectedTaskId = taskId;
        
        // Oznacz wybran kart
        document.querySelectorAll('.task-item').forEach(item => {
            item.classList.remove('selected');
        });
        const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
        if (taskElement) {
            taskElement.classList.add('selected');
        }
        
        // Zaaduj dane przepywu
        loadFlowData(taskId);
    }

    // Funkcja do adowania danych przepywu
    async function loadFlowData(taskId) {
        try {
            document.getElementById('flowVisualization').style.display = 'block';
            document.getElementById('flowDetails').style.display = 'block';
            
            const response = await fetch(`/api/v1/flow/${taskId}`);
            const flowData = await response.json();
            
            // Renderuj diagram Mermaid
            renderMermaidDiagram(flowData.mermaid_diagram);
            
            // Renderuj szczeg贸y krok贸w
            renderFlowSteps(flowData.steps);
            
            // Ustaw auto-refresh dla zada w trakcie
            if (flowData.status === 'PROCESSING') {
                startAutoRefresh(taskId);
            } else {
                stopAutoRefresh();
            }
        } catch (error) {
            console.error('Bd podczas adowania danych przepywu:', error);
            document.getElementById('mermaidContainer').innerHTML = `
                <div class="empty-state">
                    <p>Bd podczas adowania danych przepywu</p>
                </div>
            `;
        }
    }

    // Funkcja do renderowania diagramu Mermaid
    async function renderMermaidDiagram(mermaidCode) {
        const container = document.getElementById('mermaidContainer');
        container.innerHTML = `<div class="mermaid">${mermaidCode}</div>`;
        
        try {
            await mermaid.run({
                querySelector: '#mermaidContainer .mermaid'
            });
        } catch (error) {
            console.error('Bd renderowania Mermaid:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <p>Bd renderowania diagramu</p>
                    <pre style="text-align: left; font-size: 0.8rem; color: #666;">${mermaidCode}</pre>
                </div>
            `;
        }
    }

    // Funkcja do renderowania krok贸w przepywu
    function renderFlowSteps(steps) {
        const container = document.getElementById('flowStepsList');
        
        container.innerHTML = steps.map(step => `
            <li class="flow-step ${step.is_decision_gate ? 'decision-gate' : ''} ${step.status === 'error' ? 'error' : ''}">
                <div class="flow-step-header">
                    <span class="flow-step-component">
                        ${escapeHtml(step.component)}
                        ${step.is_decision_gate ? '<span class="decision-gate-badge"> Decision Gate</span>' : ''}
                    </span>
                    <span class="flow-step-time">${escapeHtml(new Date(step.timestamp).toLocaleTimeString('pl-PL'))}</span>
                </div>
                <div class="flow-step-action">${escapeHtml(step.action)}</div>
                ${step.details ? `<div class="flow-step-details">${escapeHtml(step.details)}</div>` : ''}
            </li>
        `).join('');
    }

    // Auto-refresh dla zada w trakcie
    function startAutoRefresh(taskId) {
        stopAutoRefresh();
        refreshInterval = setInterval(() => {
            loadFlowData(taskId);
        }, AUTO_REFRESH_INTERVAL_MS);
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Event listenery dla przycisk贸w
    document.getElementById('refreshTasksBtn').addEventListener('click', loadTasks);
    document.getElementById('refreshFlowBtn').addEventListener('click', () => {
        if (selectedTaskId) {
            loadFlowData(selectedTaskId);
        }
    });

    // Zatrzymaj auto-refresh przy opuszczeniu strony
    window.addEventListener('beforeunload', stopAutoRefresh);

    // Inicjalizacja
    loadTasks();
</script>
{% endblock %}
