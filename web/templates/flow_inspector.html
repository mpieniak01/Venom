{% extends "base.html" %}

{% block title %}Flow Inspector - Venom{% endblock %}

{% block nav_flow_active %}active{% endblock %}

{% block extra_css %}
<style>
    .flow-inspector-container {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 2rem;
    }

    .flow-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .flow-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .flow-header p {
        color: #666;
        font-size: 1.1rem;
    }

    .task-selector {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .task-selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .task-selector-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }

    .task-list-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 0.5rem;
    }

    .task-item {
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 4px solid transparent;
    }

    .task-item:hover {
        background: #e9ecef;
        transform: translateX(4px);
    }

    .task-item.selected {
        background: #e7f3ff;
        border-left-color: #2196F3;
    }

    .task-item.status-completed {
        border-left-color: #4CAF50;
    }

    .task-item.status-failed {
        border-left-color: #f44336;
    }

    .task-item.status-processing {
        border-left-color: #FF9800;
    }

    .task-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.3rem;
    }

    .task-item-id {
        font-weight: 600;
        font-size: 0.9rem;
        color: #333;
    }

    .task-item-status {
        padding: 0.2rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-completed { background: #d4edda; color: #155724; }
    .status-failed { background: #f8d7da; color: #721c24; }
    .status-processing { background: #fff3cd; color: #856404; }
    .status-pending { background: #d1ecf1; color: #0c5460; }

    .task-item-prompt {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.3rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .task-item-time {
        font-size: 0.75rem;
        color: #999;
    }

    .flow-visualization {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .flow-visualization-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .flow-visualization-header h3 {
        margin: 0;
        font-size: 1.4rem;
    }

    .refresh-btn {
        padding: 0.5rem 1rem;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }

    .refresh-btn:hover {
        background: #1976D2;
    }

    .mermaid-container {
        text-align: center;
        padding: 2rem;
        background: #fafafa;
        border-radius: 8px;
        overflow-x: auto;
    }

    .flow-details {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .flow-details h3 {
        margin-bottom: 1rem;
        font-size: 1.4rem;
    }

    .flow-steps {
        list-style: none;
        padding: 0;
    }

    .flow-step {
        padding: 1rem;
        margin-bottom: 0.8rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #e0e0e0;
        transition: all 0.2s;
    }

    .flow-step:hover {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .flow-step.decision-gate {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        border-left-color: #FF9800;
    }

    .flow-step.error {
        background: #ffebee;
        border-left-color: #f44336;
    }

    .flow-step-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .flow-step-component {
        font-weight: 600;
        font-size: 1rem;
    }

    .flow-step-time {
        font-size: 0.8rem;
        color: #999;
    }

    .flow-step-action {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.3rem;
    }

    .flow-step-details {
        font-size: 0.85rem;
        color: #888;
        font-style: italic;
    }

    .decision-gate-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        background: #FF9800;
        color: white;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #999;
    }

    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
    }

    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2196F3;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="flow-inspector-container">
    <div class="flow-header">
        <h1> Flow Inspector</h1>
        <p>Dynamiczna wizualizacja proces贸w decyzyjnych systemu Venom</p>
    </div>

    <!-- Task Selector -->
    <div class="task-selector">
        <div class="task-selector-header">
            <h3> Wybierz zadanie do analizy</h3>
            <button id="refreshTasksBtn" class="refresh-btn"> Odwie偶</button>
        </div>
        <div class="task-list-container" id="taskListContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>adowanie zada...</p>
            </div>
        </div>
    </div>

    <!-- Flow Visualization -->
    <div class="flow-visualization" id="flowVisualization" style="display: none;">
        <div class="flow-visualization-header">
            <h3> Diagram przepywu</h3>
            <button id="refreshFlowBtn" class="refresh-btn"> Odwie偶</button>
        </div>
        <div class="mermaid-container" id="mermaidContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Generowanie diagramu...</p>
            </div>
        </div>
    </div>

    <!-- Flow Details -->
    <div class="flow-details" id="flowDetails" style="display: none;">
        <h3> Szczeg贸y przepywu</h3>
        <ul class="flow-steps" id="flowStepsList">
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Inicjalizacja Mermaid
    mermaid.initialize({ 
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        sequence: {
            showSequenceNumbers: true,
            actorMargin: 50,
            width: 150,
            height: 65,
            boxMargin: 10,
            noteMargin: 10
        }
    });

    let selectedTaskId = null;
    let refreshInterval = null;

    // Funkcja do adowania listy zada
    async function loadTasks() {
        try {
            const response = await fetch('/api/v1/history/requests?limit=50');
            const tasks = await response.json();
            
            const container = document.getElementById('taskListContainer');
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Brak zada w historii</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="task-item status-${task.status.toLowerCase()}" data-task-id="${task.request_id}">
                    <div class="task-item-header">
                        <span class="task-item-id">${task.request_id.substring(0, 8)}...</span>
                        <span class="task-item-status status-${task.status.toLowerCase()}">${task.status}</span>
                    </div>
                    <div class="task-item-prompt">${task.prompt}</div>
                    <div class="task-item-time">${new Date(task.created_at).toLocaleString('pl-PL')}</div>
                </div>
            `).join('');

            // Dodaj event listenery do zada
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', () => {
                    const taskId = item.dataset.taskId;
                    selectTask(taskId);
                });
            });
        } catch (error) {
            console.error('Bd podczas adowania zada:', error);
            document.getElementById('taskListContainer').innerHTML = `
                <div class="empty-state">
                    <p>Bd podczas adowania zada</p>
                </div>
            `;
        }
    }

    // Funkcja do wyboru zadania
    function selectTask(taskId) {
        selectedTaskId = taskId;
        
        // Oznacz wybran kart
        document.querySelectorAll('.task-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.querySelector(`[data-task-id="${taskId}"]`).classList.add('selected');
        
        // Zaaduj dane przepywu
        loadFlowData(taskId);
    }

    // Funkcja do adowania danych przepywu
    async function loadFlowData(taskId) {
        try {
            document.getElementById('flowVisualization').style.display = 'block';
            document.getElementById('flowDetails').style.display = 'block';
            
            const response = await fetch(`/api/v1/flow/${taskId}`);
            const flowData = await response.json();
            
            // Renderuj diagram Mermaid
            renderMermaidDiagram(flowData.mermaid_diagram);
            
            // Renderuj szczeg贸y krok贸w
            renderFlowSteps(flowData.steps);
            
            // Ustaw auto-refresh dla zada w trakcie
            if (flowData.status === 'PROCESSING') {
                startAutoRefresh(taskId);
            } else {
                stopAutoRefresh();
            }
        } catch (error) {
            console.error('Bd podczas adowania danych przepywu:', error);
            document.getElementById('mermaidContainer').innerHTML = `
                <div class="empty-state">
                    <p>Bd podczas adowania danych przepywu</p>
                </div>
            `;
        }
    }

    // Funkcja do renderowania diagramu Mermaid
    async function renderMermaidDiagram(mermaidCode) {
        const container = document.getElementById('mermaidContainer');
        container.innerHTML = `<div class="mermaid">${mermaidCode}</div>`;
        
        try {
            await mermaid.run({
                querySelector: '#mermaidContainer .mermaid'
            });
        } catch (error) {
            console.error('Bd renderowania Mermaid:', error);
            container.innerHTML = `
                <div class="empty-state">
                    <p>Bd renderowania diagramu</p>
                    <pre style="text-align: left; font-size: 0.8rem; color: #666;">${mermaidCode}</pre>
                </div>
            `;
        }
    }

    // Funkcja do renderowania krok贸w przepywu
    function renderFlowSteps(steps) {
        const container = document.getElementById('flowStepsList');
        
        container.innerHTML = steps.map(step => `
            <li class="flow-step ${step.is_decision_gate ? 'decision-gate' : ''} ${step.status === 'error' ? 'error' : ''}">
                <div class="flow-step-header">
                    <span class="flow-step-component">
                        ${step.component}
                        ${step.is_decision_gate ? '<span class="decision-gate-badge"> Decision Gate</span>' : ''}
                    </span>
                    <span class="flow-step-time">${new Date(step.timestamp).toLocaleTimeString('pl-PL')}</span>
                </div>
                <div class="flow-step-action">${step.action}</div>
                ${step.details ? `<div class="flow-step-details">${step.details}</div>` : ''}
            </li>
        `).join('');
    }

    // Auto-refresh dla zada w trakcie
    function startAutoRefresh(taskId) {
        stopAutoRefresh();
        refreshInterval = setInterval(() => {
            loadFlowData(taskId);
        }, 3000); // Co 3 sekundy
    }

    function stopAutoRefresh() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }
    }

    // Event listenery dla przycisk贸w
    document.getElementById('refreshTasksBtn').addEventListener('click', loadTasks);
    document.getElementById('refreshFlowBtn').addEventListener('click', () => {
        if (selectedTaskId) {
            loadFlowData(selectedTaskId);
        }
    });

    // Zatrzymaj auto-refresh przy opuszczeniu strony
    window.addEventListener('beforeunload', stopAutoRefresh);

    // Inicjalizacja
    loadTasks();
</script>
{% endblock %}
