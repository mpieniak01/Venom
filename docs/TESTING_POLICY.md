# Testing Policy

This document is the single source of truth for test execution, coverage gates, and CI expectations.

## Goals

- Keep fast local feedback before opening a PR.
- Keep Sonar new-code coverage stable.
- Avoid duplicated test instructions across docs.

## Local Test Entry Points

### Quick smoke

```bash
source .venv/bin/activate || true
pytest -q
```

### Full backend suite (project default)

```bash
make pytest
```

### Frontend checks

```bash
npm --prefix web-next run lint
npm --prefix web-next run build
npm --prefix web-next run test:e2e
```

## Sonar Pre-Check (Local)

### Generate Sonar reports

```bash
make sonar-reports
```

Artifacts:

- `test-results/sonar/python-coverage.xml`
- `test-results/sonar/python-junit.xml`
- `web-next/coverage/lcov.info`

### Lightweight backend coverage for new code

```bash
make test-light-coverage
```

Useful overrides:

- `NEW_CODE_COVERAGE_MIN=70`
- `NEW_CODE_COV_TARGET=venom_core/execution/skills`
- `NEW_CODE_INCLUDE_BASELINE=0`

### Changed-lines coverage gate (recommended before every PR)

```bash
make check-new-code-coverage
```

Defaults:

- diff base: `origin/main`
- minimum changed-lines coverage: `70%`

Useful overrides:

```bash
NEW_CODE_CHANGED_LINES_MIN=80 make check-new-code-coverage
NEW_CODE_DIFF_BASE=origin/main make check-new-code-coverage
```

## Performance and Latency

Detailed scenarios and expected values are in:

- `docs/TESTING_CHAT_LATENCY.md`

Main commands:

- `npm --prefix web-next run test:perf`
- `pytest tests/perf/test_chat_pipeline.py -m performance`
- `./scripts/run-locust.sh`

## CI and PR Gates

Required quality gates for PRs:

- CI Lite (fast lint + selected unit tests)
- SonarCloud (bugs, vulnerabilities, maintainability, duplication)

Expected local pre-PR checks:

1. `pre-commit run --all-files`
2. `mypy venom_core`
3. `make check-new-code-coverage`

## Shortest PR Release Process

Use one command:

```bash
make pr-fast
```

What it does:

- Detects changed files against `origin/main` (or `PR_BASE_REF`).
- Runs backend fast lane only when backend-related files changed.
- Runs frontend fast lane only when `web-next/**` changed.
- Skips test lanes for docs-only changes.

Backend fast lane:

- `python3 -m compileall -q venom_core scripts tests`
- `make audit-ci-lite`
- `make check-new-code-coverage` (with CI-lite + sonar-new-code groups)

Frontend fast lane:

- `npm --prefix web-next run lint`
- `npm --prefix web-next run test:unit:ci-lite`

Optional base override:

```bash
PR_BASE_REF=origin/main make pr-fast
```

## Test Artifacts Policy

Do not commit test output artifacts.

Ignored by policy:

- `**/test-results/`
- `perf-artifacts/`
- `playwright-report/`
- Sonar local artifacts generated by `make sonar-reports`
