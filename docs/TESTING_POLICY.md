# Testing Policy

This document is the single source of truth for daily local testing, PR readiness checks, and release-oriented validation.

## Testing Ladder (from fastest to strictest)

### Level 1: Daily local work (every day)

Goal: very fast feedback while coding.

Run:

```bash
source .venv/bin/activate || true
pytest -q
```

When frontend code changes, add:

```bash
npm --prefix web-next run lint
```

### Level 2: Branch ready for PR (mandatory before push)

Goal: verify the branch with lightweight PR-equivalent gates.

Run one command:

```bash
make pr-fast
```

What it includes:

- changed-file scope detection against `origin/main` (or `PR_BASE_REF`)
- backend fast lane: compile check + CI-lite audit + changed-lines coverage gate
- frontend fast lane (only when `web-next/**` changed): lint + unit CI-lite

### Level 3: PR quality gates (mandatory before merge)

Goal: align with CI and Sonar expectations.

Required checks:

1. `pre-commit run --all-files`
2. `mypy venom_core`
3. `make check-new-code-coverage`

Coverage gate defaults:

- diff base: `origin/main`
- minimum changed-lines coverage: `80%`

Useful overrides:

```bash
NEW_CODE_CHANGED_LINES_MIN=80 make check-new-code-coverage
NEW_CODE_DIFF_BASE=origin/main make check-new-code-coverage
```

### Level 4: Release-oriented validation (when needed)

Goal: higher confidence for larger changes or pre-release checks.

Backend:

```bash
make pytest
```

`make pytest` runs backend groups in order: `heavy` -> `long` -> `fast`.

Frontend:

```bash
npm --prefix web-next run build
npm --prefix web-next run test:e2e
```

Sonar report bundle:

```bash
make sonar-reports
```

Artifacts:

- `test-results/sonar/python-coverage.xml`
- `test-results/sonar/python-junit.xml`
- `web-next/coverage/lcov.info`

Performance/latency scenarios:

- `docs/TESTING_CHAT_LATENCY.md`
- `npm --prefix web-next run test:perf`
- `pytest tests/perf/test_chat_pipeline.py -m performance`
- `./scripts/run-locust.sh`

## CI and Sonar Gates (reference)

Required PR gates:

- CI Lite (fast lint + selected unit tests)
- SonarCloud (bugs, vulnerabilities, maintainability, duplication)

## Quality Criteria and Typical Failure Areas

These are the recurring quality risks in this repository and how we measure them.

### 1) Security issues

Typical failures:

- logging user-controlled data in backend routes
- regex patterns vulnerable to catastrophic backtracking
- incomplete Security Hotspot review in Sonar

Indicators:

- Sonar `Security Hotspots Reviewed`: target `100%` for PR scope
- Sonar `Vulnerabilities` and `Bugs`: no new `Critical/High`

### 2) Spaghetti / overly complex code paths

Typical failures:

- high cognitive complexity (`brain-overload`)
- long condition trees in route handlers and orchestration code
- hard-to-read control flow with mixed responsibilities

Indicators:

- Python complexity check: `ruff check venom_core --select C901`
- Sonar Cognitive Complexity rule threshold per function: `<= 15`
- no new `Critical` maintainability issues in PR scope

### 3) Excessive nesting

Typical failures:

- deeply nested blocks/callbacks reducing readability and testability

Indicators:

- Sonar code smell on deep nesting: no new open issue in PR scope
- prefer guard clauses / early returns during refactor

### 4) Weak new-code coverage

Typical failures:

- PR passes unit tests, but changed lines remain uncovered
- tests not included in the lightweight Sonar group

Indicators:

- local changed-lines gate: `make check-new-code-coverage`
- enforced minimum: `NEW_CODE_CHANGED_LINES_MIN=80` (default)
- recommended safety target before push: `>= 80%`

## Test Artifacts Policy

Do not commit test output artifacts.

Ignored by policy:

- `**/test-results/`
- `perf-artifacts/`
- `playwright-report/`
- Sonar local artifacts generated by `make sonar-reports`

## Definition of Done (Quality Gates)

A change is `Done` only when all gates below are green for the PR scope:

1. Fast local PR gate passed: `make pr-fast`
2. Static quality passed:
   - `pre-commit run --all-files`
   - `mypy venom_core`
   - `ruff check venom_core --select C901` (no remaining complexity violations in changed scope)
3. New-code coverage gate passed:
   - `make check-new-code-coverage`
   - changed-lines coverage `>= 80%`
4. SonarCloud PR gate passed:
   - no new `Critical/High` bugs/vulnerabilities
   - no new open maintainability blocker in PR scope
   - Security Hotspots in PR scope reviewed (`100%`)
5. If frontend changed:
   - `npm --prefix web-next run lint`
   - `npm --prefix web-next run test:unit:ci-lite`
